" 基礎設定
set nocompatible
set number
set relativenumber
syntax on
filetype plugin indent on
" 分頁相關的快捷鍵
nnoremap <C-t> :tabnew<CR>    " Ctrl+t 創建新分頁
nnoremap <C-j> gT             " Ctrl+j 上一個分頁
nnoremap <C-k> gt             " Ctrl+k 下一個分頁
nnoremap <D-c> "+y            " Command+c 複製到系統剪貼簿
nnoremap <leader>tc :tabclose<CR>  " ,tc 關閉當前分頁
nnoremap gt <Nop>
nnoremap gT <Nop>
nnoremap sd <cmd>lua require('goto-preview').goto_preview_definition()<CR>
nnoremap st <cmd>lua require('goto-preview').goto_preview_type_definition()<CR>
nnoremap si <cmd>lua require('goto-preview').goto_preview_implementation()<CR>
nnoremap sD <cmd>lua require('goto-preview').goto_preview_declaration()<CR>
nnoremap sc <cmd>lua require('goto-preview').close_all_win()<CR>
nnoremap sr <cmd>lua require('goto-preview').goto_preview_references()<CR>
" lazy.nvim 安裝設定
lua << EOF
local lazypath = vim.fn.stdpath("data") .. "/lazy/lazy.nvim"
if not vim.loop.fs_stat(lazypath) then
  vim.fn.system({
    "git",
    "clone",
    "--filter=blob:none",
    "https://github.com/folke/lazy.nvim.git",
    "--branch=stable",
    lazypath,
  })
end
vim.opt.rtp:prepend(lazypath)
vim.opt.scrolloff = 5
vim.opt.expandtab = true      -- 使用空格代替 tab
vim.opt.tabstop = 4           -- tab 顯示為 4 個空格
vim.opt.shiftwidth = 4        -- 自動縮進使用 4 個空格
vim.opt.softtabstop = 4       -- 編輯時 tab 鍵產生 4 個空格
vim.g.sleuth_automatic = 0 -- 禁用 vim-sleuth 自動檢測縮排
vim.cmd([[
  highlight DiffAdd guibg=#355535 guifg=NONE      " 更亮的綠色
  highlight DiffChange guibg=#354555 guifg=NONE    " 更亮的藍色
  highlight DiffDelete guibg=#553535 guifg=NONE    " 更亮的紅色
  highlight DiffText guibg=#405565 guifg=NONE      " 更明顯的藍色
]])
-- 配置插件
require("lazy").setup({
  {
    "github/copilot.vim",
    lazy = false,
    priority = 1000,
  },
  -- 主題
  {
    'sainnhe/gruvbox-material',
    lazy = false,
    priority = 500,
    config = function()
        -- 設定背景為深色
        vim.g.gruvbox_material_background = 'hard'  -- 可選: 'hard', 'medium', 'soft'
        -- 設定前景色對比度
        vim.g.gruvbox_material_foreground = 'material'  -- 可選: 'material', 'mix', 'original'
        -- 啟用斜體
        vim.g.gruvbox_material_enable_italic = true
        -- 啟用粗體
        vim.g.gruvbox_material_enable_bold = true
        -- 設定為透明背景
        vim.g.gruvbox_material_transparent_background = 1
        -- 應用主題
        vim.cmd.colorscheme('gruvbox-material')
        -- 自定義行號顏色
        vim.cmd([[
          highlight LineNr guifg=#7c6f64 ctermfg=243
          highlight CursorLineNr guifg=#fe8019 gui=bold ctermfg=208 cterm=bold
        ]])
    end
  },
  -- gitsigns.nvim
  {
    "lewis6991/gitsigns.nvim",
    config = function()
      require("gitsigns").setup({
        signs = {
          add = { text = "+" },
          change = { text = "~" },
          delete = { text = "_" },
          topdelete = { text = "‾" },
          changedelete = { text = "~" },
        },
        on_attach = function(bufnr)
          local gs = package.loaded.gitsigns

          -- 導航到下一個或上一個修改
          vim.keymap.set("n", "]c", function()
            if vim.wo.diff then return "]c" end
            vim.schedule(function() gs.next_hunk() end)
            return "<Ignore>"
          end, {expr=true, buffer=bufnr})

          vim.keymap.set("n", "[c", function()
            if vim.wo.diff then return "[c" end
            vim.schedule(function() gs.prev_hunk() end)
            return "<Ignore>"
          end, {expr=true, buffer=bufnr})

          -- 查看當前行的 Git 歷史
          vim.keymap.set("n", "<leader>gh", gs.preview_hunk_inline, {buffer = bufnr})

          -- 查看文件的 Git blame 信息
          vim.keymap.set("n", "<leader>gb", function() gs.blame_line{full=true} end, {buffer = bufnr})
        end,
      })
    end
  },

  -- diffview.nvim
  {
    "sindrets/diffview.nvim",
    dependencies = "nvim-lua/plenary.nvim",
    config = function()
      require("diffview").setup({
        -- 配置選項
      })
      vim.keymap.set("n", "<leader>dv", ":DiffviewOpen<CR>")
      vim.keymap.set("n", "<leader>dc", ":DiffviewClose<CR>")
    end
  },
  --nvim-treesitter
  {
    "nvim-treesitter/nvim-treesitter",
    build = ":TSUpdate",
    config = function()
      require("nvim-treesitter.configs").setup({
        ensure_installed = { "lua", "vim", "vimdoc", "query", "python", "javascript", "typescript", "html", "css" },
        sync_install = false,
        auto_install = true,
        highlight = {
          enable = true,
          additional_vim_regex_highlighting = false,
        },
        indent = { enable = true },
        incremental_selection = {
          enable = true,
          keymaps = {
            init_selection = "<C-space>",
            node_incremental = "<C-space>",
            scope_incremental = "<C-s>",
            node_decremental = "<C-backspace>",
          },
        },
        fold = {enable = true},
      })

      vim.opt.foldmethod = "expr"
      vim.opt.foldexpr = "nvim_treesitter#foldexpr()"
      vim.opt.foldenable = true
      vim.opt.foldlevel = 0
    end,
  },
  -- toggleterm.nvim
  {
    'akinsho/toggleterm.nvim',
    version = "*",
    config = function()
      local Terminal = require('toggleterm.terminal').Terminal
      
      local term = Terminal:new({
        count = 1,
        direction = "float",
      })

      function _G.toggle_term_direction()
        if term.direction == "float" then
          term:close()
          term.direction = "horizontal"
          term:open()
        else
          term:close()
          term.direction = "float"
          term:open()
        end
      end

      require("toggleterm").setup({
        size = 20,
        open_mapping = [[<C-\>]],
        direction = "float",
        float_opts = {
          border = "curved",
        },
        highlights = {
          Normal = {
            guibg = "#1a1b26",    -- Tokyo Night dark background
          },
          NormalFloat = {
            link = 'Normal'
          },
          FloatBorder = {
            guifg = "#7aa2f7",    -- Tokyo Night blue
            guibg = "#1a1b26",
          },
          StatusLine = {
            guifg = "#7aa2f7",
            guibg = "#1a1b26",
          },
          StatusLineNC = {
            guifg = "#7aa2f7",
            guibg = "#1a1b26",
          },
          Cursor = {
            guifg = "#1a1b26",
            guibg = "#c0caf5",
          },
        },
        shade_terminals = true,
      })

      vim.api.nvim_create_user_command('Td', function()
        toggle_term_direction()
      end, {})
    end
  },
  -- telescope
  {
    'nvim-telescope/telescope.nvim',
    dependencies = { 
      'nvim-lua/plenary.nvim',
      { 'nvim-telescope/telescope-fzf-native.nvim', build = 'make' } -- 可選，但推薦
    },
    config = function()
      local telescope = require('telescope')
      local actions = require('telescope.actions')
      
      telescope.setup({
        defaults = {
          -- 添加這些設定
          generic_sorter = require("telescope.sorters").get_generic_fuzzy_sorter(),
          file_sorter = require("telescope.sorters").get_fuzzy_file(),
          file_previewer = require("telescope.previewers").vim_buffer_cat.new,
          grep_previewer = require("telescope.previewers").vim_buffer_vimgrep.new,
          qflist_previewer = require("telescope.previewers").vim_buffer_qflist.new,
          
          -- 使用更智能的搜索邏輯
          path_display = { "smart" },
          -- 設定檔案搜索的起始目錄
          cwd = function()
            local git_dir = vim.fn.systemlist("git rev-parse --show-toplevel")[1]
            if vim.v.shell_error == 0 then
              return git_dir
            else
              return vim.fn.getcwd()  -- 如果不是 git repo，就用當前目錄
            end
          end,

          path_display = { "truncate" },
          sorting_strategy = "ascending",
          layout_config = {
            horizontal = {
              prompt_position = "top",
              preview_width = 0.55,
            },
          },
          vimgrep_arguments = {
            "rg",
            "--color=never",
            "--no-heading",
            "--with-filename",
            "--line-number",
            "--column",
            "--smart-case",
            "--hidden",
          },
          mappings = {
            i = {
              ["<C-k>"] = actions.move_selection_previous,
              ["<C-j>"] = actions.move_selection_next,
              ["<C-q>"] = actions.send_selected_to_qflist + actions.open_qflist,
              ["<esc>"] = actions.close
            },
          },
          file_ignore_patterns = {
            "node_modules",
            ".git",
            ".next",
            "dist",
            "build"
          },
        },
        pickers = {
          find_files = {
            theme = "dropdown",
          }
        }
      })
      
      -- 載入 fzf 支援
      telescope.load_extension('fzf')
      
      -- 設定快捷鍵
      local builtin = require('telescope.builtin')
      vim.keymap.set('n', 'ff', function()
          builtin.find_files({
              cwd = vim.fn.getcwd(),
          })
      end, {})
    end
  },
  -- noice.nvim
  {
    "folke/noice.nvim",
    event = "VeryLazy",
    opts = {
      -- add any options here
      messages={
       enabled = false,
      }
    },
    dependencies = {
      -- if you lazy-load any plugin below, make sure to add proper `module="..."` entries
      "MunifTanjim/nui.nvim",
      -- OPTIONAL:
      --   `nvim-notify` is only needed, if you want to use the notification view.
      --   If not available, we use `mini` as the fallback
      "rcarriga/nvim-notify",
      }
  },
  {
    "folke/tokyonight.nvim",
    lazy = false,
    priority = 1000,
    config = function()
      require("tokyonight").setup({
        style = "storm",
        transparent = true,
      })
      vim.cmd[[colorscheme tokyonight]]
    end,
  },

  -- 語法高亮 (優先載入)
  {
    "sheerun/vim-polyglot",
    lazy = false,
    priority = 900,
  },

  {
    'numToStr/Comment.nvim',
    opts = {
        -- add any options here
    }
  },

  -- 自動偵測縮排 (在 polyglot 之後載入)
  {
    "tpope/vim-sleuth",
    lazy = false,
    priority = 800,
  },

  -- 啟動畫面
  {
    "mhinz/vim-startify",
    lazy = false,
    priority = 100,
  },
  -- LSP
  -- Note: nvim-lspconfig plugin is no longer needed for Neovim 0.11+
  -- Using built-in vim.lsp.config API instead
  { "williamboman/mason.nvim" },
  { "williamboman/mason-lspconfig.nvim" },
  -- 文件樹
  {
    "nvim-neo-tree/neo-tree.nvim",
    dependencies = {
      "nvim-lua/plenary.nvim",
      "nvim-tree/nvim-web-devicons",
      "MunifTanjim/nui.nvim",
    },
    config = function()
      require("neo-tree").setup({})
      vim.keymap.set('n', '<C-n>', ':Neotree toggle<CR>')
    end
  },
  -- 狀態列
  {
    "nvim-lualine/lualine.nvim",
    dependencies = { "nvim-tree/nvim-web-devicons" },
    config = function()
      require("lualine").setup({
        theme = 'tokyonight'
      })
    end
  },
  -- 縮排指示線
  {
    "lukas-reineke/indent-blankline.nvim",
    main = "ibl",
    config = function()
      require("ibl").setup()
    end
  },
  -- HTML 標籤自動關閉
  {
    "docunext/closetag.vim",
    ft = {'html', 'xhtml', 'xml', 'htmldjango'},
    config = function()
      vim.cmd[[
        autocmd FileType html,htmldjango let b:closetag_html_style=1
      ]]
    end,
  },

  -- 自動配對
  { "jiangmiao/auto-pairs" },

  -- 程式碼摺疊
  { "tmhedberg/SimpylFold" },

  -- 語法檢查
  { "w0rp/ale" },

  -- Pug 支援
  { "digitaltoad/vim-pug" },

  {
    "hrsh7th/nvim-cmp",  -- 補全引擎
    dependencies = {
      "hrsh7th/cmp-nvim-lsp",  -- LSP 補全
    }
  },
  {
    'tpope/vim-surround',
    event = 'VeryLazy',
  },
  -- goto-preview
  {
  "rmagatti/goto-preview",
  dependencies = { "rmagatti/logger.nvim" },
  event = "BufEnter",
  config = true, -- necessary as per https://github.com/rmagatti/goto-preview/issues/88
  },
})

-- Disable ALE's LSP support since we're using native Neovim LSP
vim.g.ale_disable_lsp = 1
EOF

imap <silent><script><expr> <C-J> copilot#Accept("\<CR>")

" 高亮設定
let g:word_highlight_active = 0
let g:current_word = ''

" 自定義高亮顏色
highlight WordHighlight guibg=#504945 guifg=#fe8019 gui=bold ctermbg=239 ctermfg=208 cterm=bold

function! HighlightWordToggle()
    let l:word = expand('<cword>')
    
" 如果沒有單字，直接返回
    if empty(l:word)
        echo "No word under cursor"
        return
    endif
    
" 如果是同一個單字，關閉高亮
    if l:word == g:current_word && g:word_highlight_active
        let g:word_highlight_active = 0
        let g:current_word = ''
        match none
        redraw
        echo "Highlight OFF"
        return
    endif
    
    " 高亮新單字
    let g:word_highlight_active = 1
    let g:current_word = l:word
    execute printf('match WordHighlight /\V\<%s\>/', escape(l:word, '/\'))
    
    " 顯示提示信息
    redraw
    echohl WarningMsg
    echo "Highlighting: " . l:word
    echohl None
endfunction

" 清除高亮的函數
function! ClearHighlight()
    let g:word_highlight_active = 0
    let g:current_word = ''
    match none
endfunction

" 映射 Ctrl+h
nnoremap <silent> <C-h> :call HighlightWordToggle()<CR>

" 可選：ESC 清除高亮
" nnoremap <silent> <ESC> :call ClearHighlight()<CR>
lua << EOF
-- LSP 設定
require("mason").setup()
require("mason-lspconfig").setup({
  ensure_installed = {
    "pyright",
    "lua_ls",
  },
  automatic_installation = true,
  handlers = {
    -- Disable default handler to prevent auto-setup
    function(server_name)
      -- Do nothing - we'll set up servers manually below
    end,
  },
})

-- LSP 伺服器設定
local capabilities = require('cmp_nvim_lsp').default_capabilities()

-- LSP 快捷鍵設定（使用 LspAttach autocmd）
vim.api.nvim_create_autocmd('LspAttach', {
  callback = function(args)
    local bufnr = args.buf
    local opts = { buffer = bufnr, noremap = true, silent = true, nowait = true }
    vim.keymap.set('n', 'K', vim.lsp.buf.hover, opts)
    vim.keymap.set('n', 'gr', require('telescope.builtin').lsp_references, opts)
    vim.keymap.set('n', 'gt', require('telescope.builtin').lsp_definitions, opts)
    vim.keymap.set('n', 'gi', require('telescope.builtin').lsp_implementations, opts)
    vim.keymap.set('n', 'gs', require('telescope.builtin').lsp_document_symbols, opts)
    vim.keymap.set('n', '<leader>ws', require('telescope.builtin').lsp_workspace_symbols, opts)
    vim.keymap.set('n', '<leader>dd', require('telescope.builtin').diagnostics, opts)
    vim.keymap.set('n', 'gb', '<C-o>', opts)
  end
})

-- Pyright 設定
vim.lsp.config('pyright', {
  cmd = { 'pyright-langserver', '--stdio' },
  filetypes = { 'python' },
  root_markers = {
    ".git",
    "pyrightconfig.json",
    "pyproject.toml",
    "setup.py",
    "setup.cfg",
    "requirements.txt",
    "Pipfile"
  },
  single_file_support = true,
  capabilities = capabilities,
  settings = {
    python = {
      analysis = {
        autoSearchPaths = true,
        useLibraryCodeForTypes = true,
        diagnosticMode = "workspace",
        typeCheckingMode = "basic",
        extraPaths = {
          vim.fn.getcwd(),
          vim.fn.expand('$PYTHONPATH'),
        },
        diagnosticSeverityOverrides = {
          reportMissingImports = "none",
          reportGeneralTypeIssues = "warning"
        }
      }
    }
  }
})

-- Lua LSP 設定
vim.lsp.config('lua_ls', {
  cmd = { 'lua-language-server' },
  filetypes = { 'lua' },
  root_markers = { '.git', '.luarc.json', '.luacheckrc' },
  single_file_support = true,
  capabilities = capabilities,
  settings = {
    Lua = {
      runtime = {
        version = 'LuaJIT'
      },
      diagnostics = {
        globals = { 'vim' }
      },
      workspace = {
        library = vim.api.nvim_get_runtime_file("", true),
        checkThirdParty = false
      },
      telemetry = {
        enable = false
      }
    }
  }
})

-- 啟用 LSP 伺服器
vim.lsp.enable('pyright')
vim.lsp.enable('lua_ls')
EOF
